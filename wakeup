#!/bin/bash
CONF_FILE="$HOME/.sleepmanager.conf"
LOG_FILE="$HOME/.sleeplog_history"
APPS_KILLED="$HOME/.sleep_killed_apps"
APPS_PENDING="$HOME/.sleep_pending_apps"

[ -f "$CONF_FILE" ] && source "$CONF_FILE"

log_message() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"; }

# Intestazione per la Dashboard
echo "==== WAKE $(date '+%Y-%m-%d %H:%M:%S') ====" >> "$LOG_FILE"

sleep 5 # Attesa stabilità sistema

IS_BATT=false
pmset -g batt | grep -q "Battery Power" && IS_BATT=true

if [ -f "$APPS_KILLED" ]; then
    while read -r app; do
        [ -z "$app" ] && continue
        if [ "$IS_BATT" = true ] && [[ "$HEAVY_APPS" =~ "$app" ]]; then
            echo "$app" >> "$APPS_PENDING"
            log_message "⏳ POSTICIPATO: $app (Batteria)"
        else
            open -a "$app" && log_message "✅ RIAPERTO: $app"
        fi
    done < "$APPS_KILLED"
    rm "$APPS_KILLED"
fi
log_message "☀️ Sistema Sveglio."