#!/bin/bash

LOG="$HOME/.sleep_log"
APPS_KILLED="$HOME/.sleep_apps_killed"

echo "==== WAKE $(date '+%Y-%m-%d %H:%M:%S') ====" >> "$LOG"

# Delay intelligente: aspetta che il sistema sia pronto
sleep 3

# Verifica che il file esista e non sia vuoto
if [ ! -f "$APPS_KILLED" ] || [ ! -s "$APPS_KILLED" ]; then
  echo "â„¹ï¸  Nessuna app da riaprire" >> "$LOG"
  echo "" >> "$LOG"
  exit 0
fi

# Log delle app da riaprire
echo "ðŸ“‹ App da riaprire: $(wc -l < "$APPS_KILLED" | tr -d ' ')" >> "$LOG"

# Contatori
REOPENED=0
SKIPPED=0
FAILED=0

# Leggi le app da riaprire (solo quelle effettivamente chiuse)
while IFS= read -r APP; do
  # Salta righe vuote
  [ -z "$APP" ] && continue
  
  # Evita app di sistema
  case "$APP" in
    "Finder"|"System Settings"|"Calendar"|"Reminders"|"Spotlight") 
      SKIPPED=$((SKIPPED + 1))
      continue 
      ;;
  esac

  # Verifica se giÃ  aperta
  if pgrep -x "$APP" > /dev/null 2>&1; then
    echo "â­ï¸  $APP giÃ  aperta" >> "$LOG"
    SKIPPED=$((SKIPPED + 1))
    continue
  fi

  # Prova a riaprire con metodo robusto
  echo "ðŸ”„ Riapro $APP" >> "$LOG"
  
  # Metodo 1: open -a (funziona per la maggior parte delle app)
  if open -a "$APP" 2>/dev/null; then
    REOPENED=$((REOPENED + 1))
    sleep 0.5
  else
    # Metodo 2: Cerca il path completo in /Applications
    APP_PATH=$(find /Applications ~/Applications -name "${APP}.app" -maxdepth 2 -type d 2>/dev/null | head -1)
    
    if [ -n "$APP_PATH" ]; then
      echo "   ðŸ“ Trovato path: $APP_PATH" >> "$LOG"
      if open "$APP_PATH" 2>/dev/null; then
        REOPENED=$((REOPENED + 1))
        sleep 0.5
      else
        echo "   âŒ Errore nell'apertura di $APP" >> "$LOG"
        FAILED=$((FAILED + 1))
      fi
    else
      echo "   âŒ App non trovata: $APP" >> "$LOG"
      FAILED=$((FAILED + 1))
    fi
  fi
  
done < "$APPS_KILLED"

echo "ðŸ“Š Riaperte: $REOPENED | Saltate: $SKIPPED | Fallite: $FAILED | Wake completato" >> "$LOG"
echo "" >> "$LOG"

# Opzionale: pulisci il file dopo il wake
# rm -f "$APPS_KILLED"