#!/bin/bash

LOG="$HOME/.sleep_log"
APPS_KILLED="$HOME/.sleep_apps_killed"

echo "==== WAKE $(date '+%Y-%m-%d %H:%M:%S') ====" >> "$LOG"

# Delay intelligente: aspetta che il sistema sia pronto
sleep 3

# Verifica che il file esista e non sia vuoto
if [ ! -f "$APPS_KILLED" ] || [ ! -s "$APPS_KILLED" ]; then
  echo "â„¹ï¸  Nessuna app da riaprire" >> "$LOG"
  echo "" >> "$LOG"
  exit 0
fi

# Contatori
REOPENED=0
SKIPPED=0
FAILED=0

# Leggi le app da riaprire (solo quelle effettivamente chiuse)
while IFS= read -r APP; do
  # Salta righe vuote
  [ -z "$APP" ] && continue
  
  #  Se vuoi NON riaprire automaticamente alcune app anche se erano state chiuse
case "$APP" in
  "Finder"|"System Settings"|"Calendar"|"Reminders"|"Spotlight") 
    SKIPPED=$((SKIPPED + 1))
    continue 
    ;;
  # "Docker")  # aggiungi qui app che NON vuoi riaprire
  #   SKIPPED=$((SKIPPED + 1))
  #   continue
  #   ;;
esac

  # Verifica se giÃ  aperta
  if pgrep -x "$APP" > /dev/null 2>&1; then
    echo "â­ï¸  $APP giÃ  aperta" >> "$LOG"
    SKIPPED=$((SKIPPED + 1))
    continue
  fi

  # Prova a riaprire
  echo "ðŸ”„ Riapro $APP" >> "$LOG"
  if open -a "$APP" 2>>"$LOG"; then
    REOPENED=$((REOPENED + 1))
    # Pausa tra aperture per non sovraccaricare il sistema
    sleep 0.5
  else
    echo "   âŒ Errore nell'apertura di $APP" >> "$LOG"
    FAILED=$((FAILED + 1))
  fi
  
done < "$APPS_KILLED"

echo "ðŸ“Š Riaperte: $REOPENED | Saltate: $SKIPPED | Fallite: $FAILED | Wake completato" >> "$LOG"
echo "" >> "$LOG"

# Opzionale: pulisci il file dopo il wake
# rm -f "$APPS_KILLED"