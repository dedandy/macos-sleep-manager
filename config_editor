#!/bin/bash
# ~/.sleepmanager_editor - Interfaccia di configurazione v4.2.1

CONF_FILE="$HOME/.sleepmanager.conf"

# Colori
CYAN='\033[1;36m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

load_conf() { 
    if [ -f "$CONF_FILE" ]; then source "$CONF_FILE"; else echo "Config non trovata"; exit 1; fi 
}

save_val() {
    local var=$1
    local val=$2
    sed -i.bak "s|^$var=.*|$var=\"$val\"|" "$CONF_FILE"
    rm "${CONF_FILE}.bak"
    load_conf
}

# Nuova funzione per gestire le liste (Heavy Apps e Whitelist)
update_list() {
    local var_name=$1
    local current_val=$2
    
    echo -e "\n${CYAN}Modifica Lista: $var_name${NC}"
    echo -e "Valore attuale: ${YELLOW}$current_val${NC}"
    echo -e "1) Aggiungi elemento"
    echo -e "2) Sovrascrivi/Reset totale"
    echo -e "3) Torna indietro"
    read -p "Scegli: " list_opt
    
    case $list_opt in
        1)
            read -p "Inserisci nome app da aggiungere: " new_item
            if [ -z "$current_val" ]; then
                save_val "$var_name" "$new_item"
            else
                # Aggiunge con il pipe | se non è vuoto
                save_val "$var_name" "$current_val|$new_item"
            fi
            ;;
        2)
            read -p "Inserisci nuova lista completa (es. App1|App2): " new_list
            save_val "$var_name" "$new_list"
            ;;
        *) return ;;
    esac
}

show_menu() {
    clear
    load_conf
    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║      macOS SLEEP MANAGER EDITOR        ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo -e "Seleziona parametro da modificare:"
    echo ""
    echo -e "1) Notifiche:      ${YELLOW}$ENABLE_NOTIFICATIONS${NC}"
    echo -e "2) Chiusura Sicura: ${YELLOW}$SAFE_QUIT_MODE${NC}"
    echo -e "3) Soglia CPU:     ${YELLOW}$CPU_THRESHOLD%${NC}"
    echo -e "4) Whitelist:      ${YELLOW}$WHITELIST${NC}"
    echo -e "5) Heavy Apps:     ${YELLOW}$HEAVY_APPS${NC}"
    echo ""
    echo -e "s) Salva ed Esci"
    echo -e "q) Annulla"
    echo ""
    read -p "Opzione > " opt
}

while true; do
    show_menu
    case $opt in
        1) [[ "$ENABLE_NOTIFICATIONS" == "true" ]] && save_val "ENABLE_NOTIFICATIONS" "false" || save_val "ENABLE_NOTIFICATIONS" "true" ;;
        2) [[ "$SAFE_QUIT_MODE" == "true" ]] && save_val "SAFE_QUIT_MODE" "false" || save_val "SAFE_QUIT_MODE" "true" ;;
        3) read -p "Nuova soglia CPU (es. 2.0): " nc; save_val "CPU_THRESHOLD" "$nc" ;;
        4) update_list "WHITELIST" "$WHITELIST" ;;
        5) update_list "HEAVY_APPS" "$HEAVY_APPS" ;;
        s|q) exit 0 ;;
        *) echo -e "${RED}Opzione non valida${NC}"; sleep 1 ;;
    esac
done