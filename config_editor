#!/bin/bash
# ~/.sleepmanager_editor v4.3.1

CONF_FILE="$HOME/.sleepmanager.conf"
CYAN='\033[1;36m'; YELLOW='\033[1;33m'; GREEN='\033[0;32m'; RED='\033[0;31m'; NC='\033[0m'

load_conf() { source "$CONF_FILE"; }
save_val() { sed -i.bak "s|^$1=.*|$1=\"$2\"|" "$CONF_FILE" && rm "${CONF_FILE}.bak" && load_conf; }

update_list() {
    clear
    echo -e "${CYAN}Modifica Lista: $1${NC}\nAttuale: ${YELLOW}$2${NC}\n"
    echo "1) Aggiungi elemento"
    echo "2) Reset totale"
    echo "3) Indietro"
    read -p "> " lo
    case $lo in
        1) read -p "Nome app: " ni; [ -z "$2" ] && save_val "$1" "$ni" || save_val "$1" "$2|$ni" ;;
        2) read -p "Nuova lista: " nl; save_val "$1" "$nl" ;;
    esac
}

while true; do
    load_conf
    clear
    echo -e "${CYAN}macOS SLEEP MANAGER EDITOR v4.3.1${NC}\n"
    echo -e "1) Notifiche:      ${YELLOW}$ENABLE_NOTIFICATIONS${NC}"
    echo -e "2) Chiusura Sicura: ${YELLOW}$SAFE_QUIT_MODE${NC}"
    echo -e "3) Soglia CPU:     ${YELLOW}$CPU_THRESHOLD%${NC}"
    echo -e "4) Whitelist:      ${YELLOW}$WHITELIST${NC}"
    echo -e "5) Heavy Apps:     ${YELLOW}$HEAVY_APPS${NC}"
    echo -e "\ns) Salva ed Esci  q) Annulla"
    read -p "> " opt
    case $opt in
        1) [[ "$ENABLE_NOTIFICATIONS" == "true" ]] && save_val "ENABLE_NOTIFICATIONS" "false" || save_val "ENABLE_NOTIFICATIONS" "true" ;;
        2) [[ "$SAFE_QUIT_MODE" == "true" ]] && save_val "SAFE_QUIT_MODE" "false" || save_val "SAFE_QUIT_MODE" "true" ;;
        3) read -p "Soglia: " nc; save_val "CPU_THRESHOLD" "$nc" ;;
        4) update_list "WHITELIST" "$WHITELIST" ;;
        5) update_list "HEAVY_APPS" "$HEAVY_APPS" ;;
        s|q) exit 0 ;;
    esac
done