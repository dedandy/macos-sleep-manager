#!/bin/bash

# Configurazione Percorsi
CONF_FILE="$HOME/.sleepmanager.conf"
LOG_FILE="$HOME/.sleeplog_history"
APPS_KILLED="$HOME/.sleep_killed_apps"

# Carica Configurazione Utente
if [ -f "$CONF_FILE" ]; then
    source "$CONF_FILE"
else
    # Fallback se il file di config non esiste (Safe Defaults)
    CPU_THRESHOLD=1.0
    SAFE_QUIT_MODE=false
    HEAVY_APPS=""
    WHITELIST="Music|Spotify"
fi

# Funzione di logging
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Funzione Chiusura Sicura
quit_app() {
    local app="$1"
    local force_needed=true
    
    if [ "$SAFE_QUIT_MODE" = "true" ]; then
        # Tenta chiusura gentile via AppleScript
        osascript -e "quit app \"$app\"" >/dev/null 2>&1
        
        # Aspetta fino a 3 secondi che si chiuda
        for i in {1..6}; do
            if ! pgrep -x "$app" > /dev/null; then
                force_needed=false
                break
            fi
            sleep 0.5
        done
    fi
    
    # Se Ã¨ ancora viva (o se SAFE_QUIT_MODE Ã¨ false), usa la forza
    if [ "$force_needed" = "true" ]; then
        pkill -f "$app"
        log_message "ðŸ”ª KILL (Forzato): $app"
    else
        log_message "ðŸ‘‹ QUIT (Gentile): $app"
    fi
}

# Inizio
log_message "------------------------------------------------"
log_message "[SLEEP] ðŸŒ™ Inizio procedura v4.0..."

# Pulisce file temporaneo
echo "" > "$APPS_KILLED"

# Analisi Batteria
BATT_PCT=$(pmset -g batt | grep -o "[0-9]*%" | head -1)
log_message "ðŸ”‹ Batteria: $BATT_PCT. Analisi processi..."

# Scansione Processi
ps -r -o %cpu,comm | grep -v "0.0" | grep -v "PROCESS" | while read -r cpu comm; do
    
    app_name=$(basename "$comm")
    
    # Salta Whitelist e Processi di Sistema
    # Aggiungiamo processi critici di sistema alla whitelist utente per sicurezza
    FULL_WHITELIST="Finder|loginwindow|WindowServer|syslogd|UserEventAgent|kextd|fseventsd|distnoted|$WHITELIST"
    
    if echo "$app_name" | grep -qE "$FULL_WHITELIST"; then
        continue
    fi

    should_kill=false
    reason=""

    # 1. Check CPU
    if (( $(echo "$cpu >= $CPU_THRESHOLD" | bc -l) )); then
        should_kill=true
        reason="CPU alta ($cpu%)"
    fi

    # 2. Check Eco-Wake (Heavy Apps)
    if [ -n "$HEAVY_APPS" ]; then
        if echo "$HEAVY_APPS" | grep -q "$app_name"; then
            should_kill=true
            reason="Eco-Wake Policy"
        fi
    fi

    if [ "$should_kill" = true ]; then
        echo "$app_name" >> "$APPS_KILLED"
        quit_app "$app_name"
    fi

done

log_message "ðŸ’¤ Sistema pronto per lo sleep."