# In ~/.sleep v4.5
# Uccide i processi che solitamente bloccano l'ibernazione (es. update di sistema o print job rimasti appesi)
pkill -f "softwareupdated"
pkill -f "cupsd"

# Logga lo stato attuale per debug futuro
echo "INFO: Stato prima dello sleep..." >> "$LOG_FILE"
pmset -g assertions >> "$LOG_FILE"

# Disattiva le sveglie di rete (elimina i Dark Wakes)
sudo pmset -a tcpkeepalive 0 proximitywake 0

# Scansione processi filtrata solo per il tuo utente ($USER)
# Questo evita di killare i demoni di sistema (root) che causano loop
ps -u "$USER" -o %cpu,comm | sed '1d' | while read -r cpu comm; do
    app_name=$(basename -- "$comm")
    
    # SUPER WHITELIST: Proteggiamo i componenti vitali dell'interfaccia
    if echo "$app_name" | grep -qE "Finder|loginwindow|WindowServer|ControlCenter|Dock|WallpaperAgent|WindowManager|$WHITELIST"; then continue; fi

    # GESTIONE SICUREZZA: Congeliamo (STOP) invece di uccidere
    if echo "$app_name" | grep -qE "RTProtectionDaemon|Malwarebytes|virus|security|Logi"; then
        pkill -STOP -f "$app_name"
        echo "  [FREEZE] $app_name (Sospeso)" >> "$LOG_FILE"
        continue
    fi

    # KILL SELETTIVO: Solo app utente pesanti
    if (( $(echo "$cpu >= $CPU_THRESHOLD" | bc -l) )) || [[ "$HEAVY_APPS" =~ "$app_name" ]]; then
        echo "$app_name" >> "$APPS_KILLED"
        pkill -f "$app_name"
        echo "  [KILL] $app_name ($cpu%)" >> "$LOG_FILE"
    fi
done