#!/bin/bash
# ~/.sleep v4.5.2
LOG_FILE="$HOME/.sleeplog_history"
CONF_FILE="$HOME/.sleepmanager.conf"
[ -f "$CONF_FILE" ] && source "$CONF_FILE"

# Cattura batteria
BATT_START=$(pmset -g batt | grep -o "[0-9]*%" | head -1)
echo "$BATT_START" > "$HOME/.sleep_batt_start"

# Debug Assersioni: uccidiamo chi impedisce lo sleep profondo
pkill -f "softwareupdated" 
pkill -f "cupsd" # Processi di stampa rimasti appesi

echo "==== SESSION_START $(date '+%Y-%m-%d %H:%M:%S') ====" >> "$LOG_FILE"
echo "ACTION: SLEEP | BATT: $BATT_START" >> "$LOG_FILE"

# Congelamento e chiusura app (Solo Utente)
ps -u "$USER" -o %cpu,comm | sed '1d' | while read -r cpu comm; do
    app_name=$(basename -- "$comm")
    if echo "$app_name" | grep -qE "Finder|WindowServer|ControlCenter|Dock|WallpaperAgent|WindowManager|$WHITELIST"; then continue; fi
    
    if echo "$app_name" | grep -qE "RTProtectionDaemon|Malwarebytes|Logi|security"; then
        pkill -STOP -f "$app_name"
        echo "  [FREEZE] $app_name" >> "$LOG_FILE"
    elif (( $(echo "$cpu >= $CPU_THRESHOLD" | bc -l) )) || [[ "$HEAVY_APPS" =~ "$app_name" ]]; then
        echo "$app_name" >> "$HOME/.sleep_killed_apps"
        pkill -9 -f "$app_name"
        echo "  [KILL] $app_name ($cpu%)" >> "$LOG_FILE"
    fi
done
echo "==== SESSION_END ====" >> "$LOG_FILE"