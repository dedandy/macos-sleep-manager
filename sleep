#!/bin/bash
CONF_FILE="$HOME/.sleepmanager.conf"
LOG_FILE="$HOME/.sleeplog_history"
APPS_KILLED="$HOME/.sleep_killed_apps"
[ -f "$CONF_FILE" ] && source "$CONF_FILE"

# PULIZIA DASHBOARD: Ogni volta che chiudi, il log riparte da zero per la dashboard
echo "==== SLEEP $(date '+%Y-%m-%d %H:%M:%S') ====" > "$LOG_FILE"

log_message() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"; }

ps -r -A -o %cpu,comm | sed '1d' | grep -v "^ *0.0" | while read -r cpu comm; do
    if ! [[ "$cpu" =~ ^[0-9.]+$ ]]; then continue; fi
    app_name=$(basename -- "$comm")
    if echo "$app_name" | grep -qE "Finder|loginwindow|WindowServer|syslogd|UserEventAgent|launchd|kernel_task|$WHITELIST"; then continue; fi
    if (( $(echo "$cpu >= $CPU_THRESHOLD" | bc -l) )) || [[ "$HEAVY_APPS" =~ "$app_name" ]]; then
        echo "$app_name" >> "$APPS_KILLED"
        pkill -f "$app_name"
        log_message "ðŸ”ª KILL: $app_name"
    fi
done
log_message "ðŸ’¤ Sistema pronto."