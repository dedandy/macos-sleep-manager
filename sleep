#!/bin/bash

# Configurazione
LOG_FILE="$HOME/.sleeplog_history"
APPS_KILLED="$HOME/.sleep_killed_apps"
CPU_THRESHOLD=1.0
WHITELIST="Finder|System Events|loginwindow|WindowServer|syslogd|UserEventAgent|kextd|fseventsd|distnoted"

# QUESTA LISTA VIENE AGGIORNATA DA INSTALL.SH
# App che devono essere chiuse SEMPRE per garantire l'Eco-Wake
ALWAYS_KILL_LIST=""

# Funzione di logging
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Inizio Log
log_message "------------------------------------------------"
log_message "[SLEEP] ðŸŒ™ Inizio procedura di sospensione..."

# Pulizia file temporaneo
echo "" > "$APPS_KILLED"

# Ottieni livello batteria per il log
BATT_PCT=$(pmset -g batt | grep -o "[0-9]*%" | head -1)
log_message "ðŸ”‹ Batteria al $BATT_PCT. Analisi processi..."

# Ciclo sui processi utente
# Esclude processi di root e di sistema per sicurezza
ps -r -o %cpu,comm | grep -v "0.0" | grep -v "PROCESS" | while read -r cpu comm; do
    
    # Rimuovi path completo (es. /Applications/Safari.app/Contents/MacOS/Safari -> Safari)
    app_name=$(basename "$comm")
    
    # Salta processi in whitelist
    if echo "$app_name" | grep -qE "$WHITELIST"; then
        continue
    fi

    should_kill=false
    reason=""

    # 1. CONTROLLO CPU
    # Usa bc per confronto decimale
    if (( $(echo "$cpu >= $CPU_THRESHOLD" | bc -l) )); then
        should_kill=true
        reason="CPU eccessiva ($cpu%)"
    fi

    # 2. CONTROLLO ALWAYS KILL (Eco-Wake)
    # Se l'app Ã¨ nella lista dei "pesanti", muore sempre.
    if [ -n "$ALWAYS_KILL_LIST" ]; then
        # Usa i pipe | come delimitatori per grep esatto
        if echo "$ALWAYS_KILL_LIST" | grep -q "$app_name"; then
            should_kill=true
            reason="App pesante (Eco-Wake policy)"
        fi
    fi

    if [ "$should_kill" = true ]; then
        # Salva nome app per il wakeup
        echo "$app_name" >> "$APPS_KILLED"
        
        # Kill gentile
        pkill -f "$app_name"
        log_message "ðŸ”ª KILL: $app_name ($reason)"
    fi

done

log_message "ðŸ’¤ Sistema pronto per lo sleep."