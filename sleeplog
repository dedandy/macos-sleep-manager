#!/bin/bash
# ~/.sleeplog v4.4
LOG_FILE="$HOME/.sleeplog_history"
C_CYAN='\033[1;36m'; C_YELLOW='\033[1;33m'; C_GREEN='\033[0;32m'; C_RED='\033[0;31m'; C_GRAY='\033[0;90m'; NC='\033[0m'

format_output() {
    sed "s/ACTION: SLEEP/$(echo -e "${C_GRAY}ðŸ’¤ SLEEP${NC}")/g" | \
    sed "s/ACTION: WAKE/$(echo -e "${C_GREEN}â˜€ï¸ WAKE${NC}")/g" | \
    sed "s/DELTA: -0%/$(echo -e "${C_GREEN}DELTA: 0% (PERFETTO)${NC}")/g" | \
    sed "s/DELTA: -[1-9]%/$(echo -e "${C_YELLOW}&${NC}")/g" | \
    sed "s/\[KILL\]/$(echo -e "${C_RED}ðŸ”ª KILL${NC}")/g" | \
    sed "s/\[POSTPONE\]/$(echo -e "${C_YELLOW}â³ POSTPONE${NC}")/g" | \
    sed "s/\[RESTORE\]/$(echo -e "${C_GREEN}âœ… RESTORE${NC}")/g"
}

show_stats() {
    echo -e "${C_CYAN}ðŸ“Š STATISTICHE DI EFFICIENZA${NC}"
    total_kills=$(grep -c "\[KILL\]" "$LOG_FILE")
    avg_delta=$(grep "DELTA:" "$LOG_FILE" | sed 's/.*DELTA: -\([0-9]*\)%.*/\1/' | awk '{s+=$1} END {if (NR>0) printf "%.1f", s/NR; else print "0"}')
    echo -e "App chiuse totali: ${C_YELLOW}$total_kills${NC}"
    echo -e "Consumo medio: ${C_RED}-$avg_delta%${NC} per sessione"
}

case "$1" in
    today) grep -A 20 "$(date '+%Y-%m-%d')" "$LOG_FILE" | format_output ;;
    week) grep -A 20 "$(date -v-7d '+%Y-%m')" "$LOG_FILE" | format_output ;;
    all) cat "$LOG_FILE" | format_output ;;
    stats) show_stats ;;
    clear) > "$LOG_FILE"; echo "Log puliti." ;;
    *) 
        echo -e "${C_CYAN} ULTIMA ATTIVITÃ€:${NC}"
        tail -r "$LOG_FILE" | awk '/==== SESSION_START/{if(p)exit;p=1}p' | tail -r | format_output 
        echo -e "\n${C_GRAY}Usa: sleeplog [today|week|all|stats|clear]${NC}"
        ;;
esac